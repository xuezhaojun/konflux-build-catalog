name: Update Tekton Task Bundles

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0" # Runs weekly on Sunday at 00:00 UTC

jobs:
  update-tekton-task-bundles:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pipeline_file:
          - common.yaml
          - common-base.yaml
          - common-fbc.yaml
          - common-oci-ta.yaml
      fail-fast: false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo jq
          sudo wget -O /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.44.1/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Run update-tekton-task-bundles.sh
        id: update_bundles
        run: |
          bash ./update-tekton-task-bundles.sh pipelines/${{ matrix.pipeline_file }} > migration_data.json

      - name: Check if migration is required
        id: check_migration
        run: |
          if jq -e 'length > 0' migration_data.json; then
            echo "migration_required=true" >> $GITHUB_OUTPUT

            # Format migration data for issue body
            migration_count=$(jq 'length' migration_data.json)
            migration_details=$(jq -r '.[] | "- **\(.depName)**: \(.currentValue) ‚Üí \(.newValue)\n  - Link: \(.link)\n  - Package File: \(.packageFile)"' migration_data.json)

            # Create issue body with proper formatting and set as output
            echo "issue_body<<EOF" >> $GITHUB_OUTPUT
            echo "## Tekton Task Bundle Migration Required" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "The automated Tekton task bundle update process has detected that **${migration_count}** task bundle(s) require migration to newer versions in **${{ matrix.pipeline_file }}**." >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### Migration Details:" >> $GITHUB_OUTPUT
            echo -e "$migration_details" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### Action Required:" >> $GITHUB_OUTPUT
            echo "Please review the migration details above and manually update the task bundles. The automated update process has been halted to prevent potential breaking changes." >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### Migration Data (JSON):" >> $GITHUB_OUTPUT
            echo '```json' >> $GITHUB_OUTPUT
            cat migration_data.json | jq . >> $GITHUB_OUTPUT
            echo '```' >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "### Next Steps:" >> $GITHUB_OUTPUT
            echo "1. Review the changes required for each task bundle" >> $GITHUB_OUTPUT
            echo "2. Test the new versions in a development environment" >> $GITHUB_OUTPUT
            echo "3. Manually update the task bundle references" >> $GITHUB_OUTPUT
            echo "4. Close this issue once migration is complete" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "migration_required=false" >> $GITHUB_OUTPUT
          fi

      - name: Extract pipeline filename without extension
        if: steps.check_migration.outputs.migration_required == 'true'
        id: extract_filename
        run: |
          filename="${{ matrix.pipeline_file }}"
          filename_no_ext="${filename%.yaml}"
          # Replace dots with underscores to avoid label parsing issues
          filename_label="${filename_no_ext//./_}"
          echo "filename_label=${filename_label}" >> $GITHUB_OUTPUT

      - name: Check for existing migration issue
        if: steps.check_migration.outputs.migration_required == 'true'
        id: check_existing_issue
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          filename_label="${{ steps.extract_filename.outputs.filename_label }}"

          # Search for open issues with both migration and filename labels
          existing_issues=$(gh issue list \
            --repo ${{ github.repository }} \
            --state open \
            --label "migration,${filename_label}" \
            --json number \
            --jq 'length')

          if [ "$existing_issues" -gt 0 ]; then
            echo "issue_exists=true" >> $GITHUB_OUTPUT
            echo "Found $existing_issues existing migration issue(s) for ${filename_label}"
          else
            echo "issue_exists=false" >> $GITHUB_OUTPUT
            echo "No existing migration issue found for ${filename_label}"
          fi

      - name: Create issue for migration
        if: steps.check_migration.outputs.migration_required == 'true' && steps.check_existing_issue.outputs.issue_exists == 'false'
        uses: imjohnbo/issue-bot@v3
        with:
          token: ${{ github.token }}
          title: "Tekton Task Bundle Migration Required - ${{ matrix.pipeline_file }} - ${{ github.run_id }}"
          body: ${{ steps.check_migration.outputs.issue_body }}
          labels: "migration, ${{ steps.extract_filename.outputs.filename_label }}"
          assignees: ${{ github.actor }}

      - name: Send Slack notification for migration
        if: steps.check_migration.outputs.migration_required == 'true' && steps.check_existing_issue.outputs.issue_exists == 'false'
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "üö® Tekton Task Bundle Migration Required - ${{ matrix.pipeline_file }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üö® Tekton Task Bundle Migration Required - ${{ matrix.pipeline_file }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Pipeline File:*\n${{ matrix.pipeline_file }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Workflow Run:*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|${{ github.run_id }}>"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "The automated Tekton task bundle update process has detected task bundles that require manual migration. An issue has been created for tracking."
                  }
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow Run"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Repository Issues"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/issues"
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Fail if migration is required
        run: |
          if jq -e 'length > 0' migration_data.json; then
            echo "Migration required for ${{ matrix.pipeline_file }}. Please review and migrate before proceeding."
            cat migration_data.json
            exit 1
          fi

      - name: Check if pipeline file changed
        id: check_diff
        run: |
          git config --global --add safe.directory "$GITHUB_WORKSPACE"
          if git diff --quiet pipelines/${{ matrix.pipeline_file }}; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request if needed
        if: steps.check_diff.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update Tekton Task Bundles in ${{ matrix.pipeline_file }}"
          title: "chore: update Tekton Task Bundles in ${{ matrix.pipeline_file }}"
          body: "Automated PR to update Tekton Task Bundles in ${{ matrix.pipeline_file }}. No migration required."
          branch: tekton-bundle-update-${{ matrix.pipeline_file }}
          base: main
          add-paths: pipelines/${{ matrix.pipeline_file }}
          signoff: true
          labels: |
            automated-update

  create-kubeopencode-task:
    runs-on: ubuntu-latest
    needs: update-tekton-task-bundles
    if: always()
    steps:
      - name: Check for open migration issues
        id: check_migration_issues
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          migration_issues=$(gh issue list \
            --repo ${{ github.repository }} \
            --state open \
            --label "migration" \
            --json number \
            --jq 'length')

          if [ "$migration_issues" -gt 0 ]; then
            echo "has_migration=true" >> $GITHUB_OUTPUT
            echo "Found $migration_issues open migration issue(s)"
          else
            echo "has_migration=false" >> $GITHUB_OUTPUT
            echo "No open migration issues found"
          fi

      - name: Create KubeOpenCode migration task
        if: steps.check_migration_issues.outputs.has_migration == 'true'
        env:
          KUBEOPENCODE_CLUSTER_URL: ${{ secrets.KUBEOPENCODE_CLUSTER_URL }}
          KUBEOPENCODE_TOKEN: ${{ secrets.KUBEOPENCODE_TOKEN }}
          KUBEOPENCODE_CA: ${{ secrets.KUBEOPENCODE_CA }}
        run: |
          curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
          chmod +x kubectl
          sudo mv kubectl /usr/local/bin/

          echo "${KUBEOPENCODE_CA}" > /tmp/kubeopencode-ca.crt

          cat <<'EOF' | kubectl \
            --server="${KUBEOPENCODE_CLUSTER_URL}" \
            --token="${KUBEOPENCODE_TOKEN}" \
            --certificate-authority=/tmp/kubeopencode-ca.crt \
            create -f -
          apiVersion: kubeopencode.io/v1alpha1
          kind: Task
          metadata:
            generateName: konflux-batch-migration-task-
            namespace: acm
          spec:
            # Reference the agent that will execute tasks created from this template
            agentRef:
              name: fast
            # Contexts that will be merged with task-specific contexts
            contexts:
              - name: bot-instructions
                type: Text
                text: |
                  ## Agent Overview
                  You are an agent that handles **batch** pipeline migration tasks for the konflux-build-catalog repository (https://github.com/stolostron/konflux-build-catalog).

                  **Important:** The konflux-build-catalog repository is already mounted at `./konflux-build-catalog` via Git context. Do NOT run `git clone` - just use the files directly from that path.

                  ## Batch Processing Workflow

                  ### Step 1: Collect All Migration Issues
                  First, list all open issues with the `migration` label:
                  ```bash
                  gh issue list --repo stolostron/konflux-build-catalog --label migration --state open --json number,title,url,body
                  ```

                  If no issues are found, send a Slack notification and exit:
                  ```bash
                  curl -X POST -H 'Content-type: application/json' \
                    --data '{"text":"No open migration issues found. Nothing to process."}' \
                    "$SLACK_WEBHOOK_URL"
                  ```

                  ### Step 2: Parse and Group Issues
                  Each issue body contains a JSON block with migration details. Extract and parse this JSON:
                  ```json
                  {
                    "depName": "quay.io/konflux-ci/tekton-catalog/task-buildah-oci-ta",
                    "currentValue": "0.7",
                    "newValue": "0.8",
                    "currentDigest": "sha256:...",
                    "newDigest": "sha256:...",
                    "packageFile": "pipelines/common-oci-ta.yaml"
                  }
                  ```

                  Group all migrations by `packageFile` to minimize the number of file edits.

                  ### Step 3: Check MIGRATION.md and Apply Migration Steps
                  For each task bundle, check if there are breaking changes by fetching:
                  ```
                  https://raw.githubusercontent.com/konflux-ci/build-definitions/main/task/<task-name>/<new-version>/MIGRATION.md
                  ```

                  Extract `<task-name>` from `depName` (e.g., `task-buildah-oci-ta` from `quay.io/konflux-ci/tekton-catalog/task-buildah-oci-ta`).

                  - If MIGRATION.md says "no action needed" ‚Üí proceed with simple version+digest update
                  - If MIGRATION.md has breaking changes ‚Üí **read the migration steps carefully and apply ALL described changes** to the pipeline YAML file:
                    * **Remove deprecated parameters**: find and delete the param entries (both the parameter definition and any `value` references) from the task's `params` list in the pipeline YAML
                    * **Remove deprecated results**: find and delete any references to removed results in subsequent tasks (e.g., `$(tasks.<task>.results.<result>)`)
                    * **Rename parameters/results**: if the migration guide says a parameter or result was renamed, update all references accordingly
                    * **Add new required parameters**: if the migration guide specifies new required parameters with default or recommended values, add them to the task's `params` list
                    * **Apply any other changes** described in the migration guide
                    After applying all migration steps, proceed with the version+digest update as normal.
                    Track which migration actions were applied for each task ‚Äî this information will be included in the PR body.
                  - **Only skip** if the migration steps are truly ambiguous or require information not available to you (e.g., a new required parameter with no documented default value and no way to determine the correct value). Add skipped issues to the skipped list with a reason.

                  ### Step 4: Create One PR Per Pipeline File
                  Due to CI requirements, each pipeline file MUST have its own separate PR.

                  For each `packageFile` group (from Step 2), perform these operations:

                  ```bash
                  # 1. Create a dedicated branch from main
                  cd ./konflux-build-catalog
                  git checkout main
                  git pull origin main
                  BRANCH_NAME="chore/migrate-$(basename $PACKAGE_FILE .yaml)-$(date +%Y%m%d%H%M)"
                  git checkout -b "$BRANCH_NAME"

                  # 2. Update bundle references in the file
                  # For each migration in this file group:
                  #   - Find the bundle reference matching `depName`
                  #   - Update version tag AND digest:
                  #     Old: <depName>:<currentValue>@<currentDigest>
                  #     New: <depName>:<newValue>@<newDigest>
                  #   - Use the exact `newDigest` value from the issue JSON

                  # 3. Commit and push
                  git add "$PACKAGE_FILE"
                  git commit -s -m "chore: migrate tekton bundles in $(basename $PACKAGE_FILE)"
                  git push origin "$BRANCH_NAME"

                  # 4. Create PR
                  gh pr create --repo stolostron/konflux-build-catalog \
                    --title "chore: migrate tekton bundles in $(basename $PACKAGE_FILE)" \
                    --body "$(cat <<EOF
                  ## Summary
                  Automated migration of Tekton task bundles in \`$PACKAGE_FILE\`.

                  ## Issues Addressed
                  - Fixes #<issue1>
                  - Fixes #<issue2>
                  ...

                  ## Changes
                  | Task | Version |
                  |------|---------|
                  | <task1> | <currentValue1> ‚Üí <newValue1> |
                  | <task2> | <currentValue2> ‚Üí <newValue2> |
                  ...

                  ## Migration Steps Applied
                  _(Include this section only if breaking changes were handled)_
                  | Task | Migration Action |
                  |------|-----------------|
                  | <task1> | <description of migration actions applied, e.g. "Removed deprecated params: image-url, rebuild, skip-checks. Removed result: build"> |
                  ...

                  EOF
                  )"

                  # 5. Return to main for next file
                  git checkout main
                  ```

                  **Important:**
                  - Create a separate branch and PR for EACH pipeline file
                  - Use "Fixes #xxx" syntax to automatically close issues when PR is merged
                  - Issues affecting the same file should be grouped into one PR for that file
                  - Track all created PR URLs for the Slack notification

                  ### Step 5: Send Slack Notification

                  **Success (all PRs created):**
                  ```bash
                  curl -X POST -H 'Content-type: application/json' \
                    --data '{"text":"<@U01TX25RJ3B> Batch migration completed!\n\nPRs created: '"$PR_COUNT"'\n'"$PR_LIST"'\n\nIssues addressed: '"$ISSUE_COUNT"'"}' \
                    "$SLACK_WEBHOOK_URL"
                  ```

                  Where `$PR_LIST` is a newline-separated list of PR URLs. Mark PRs that include migration steps so reviewers know which ones need closer attention:
                  ```
                  - common-oci-ta.yaml: https://github.com/stolostron/konflux-build-catalog/pull/123
                  - common.yaml: https://github.com/stolostron/konflux-build-catalog/pull/125 ‚ö†Ô∏è includes migration changes
                  - common-fbc.yaml: https://github.com/stolostron/konflux-build-catalog/pull/124 ‚ö†Ô∏è includes migration changes
                  ```

                  **Partial success (some issues skipped):**
                  ```bash
                  curl -X POST -H 'Content-type: application/json' \
                    --data '{"text":"<@U01TX25RJ3B> Batch migration completed with some issues skipped.\n\nPRs created: '"$PR_COUNT"'\n'"$PR_LIST"'\n\nProcessed: '"$SUCCESS_COUNT"' issues\nSkipped (unable to auto-migrate): '"$SKIPPED_ISSUES"'\n\nPlease handle skipped issues manually."}' \
                    "$SLACK_WEBHOOK_URL"
                  ```

                  **No processable issues:**
                  ```bash
                  curl -X POST -H 'Content-type: application/json' \
                    --data '{"text":"<@U01TX25RJ3B> Batch migration: All issues require manual intervention (migration steps too ambiguous for automated handling).\n\nSkipped issues: '"$SKIPPED_ISSUES"'\n\nPlease handle manually."}' \
                    "$SLACK_WEBHOOK_URL"
                  ```

                  ## Important Rules
                  1. Create ONE PR per pipeline file (not one PR for all changes)
                  2. Group issues by `packageFile` - all issues for the same file go into one PR
                  3. Use the exact `newDigest` value from each issue's JSON - do not compute or fetch digests
                  4. If MIGRATION.md has breaking changes, read the migration guide and apply all described changes to the pipeline YAML (remove deprecated params, remove result references, rename fields, add new params, etc.). Only skip if the migration steps are truly ambiguous or require information not available to you.
                  5. Always use "Fixes #xxx" in PR body to auto-close issues
                  6. If no issues can be processed, do NOT create any PRs
              - name: konflux-build-catalog
                type: Git
                git:
                  repository: https://github.com/stolostron/konflux-build-catalog.git
                  ref: main
                mountPath: konflux-build-catalog
            description: |
              Process ALL open migration issues in batch mode.

              The agent will:
              1. List all issues with 'migration' label from stolostron/konflux-build-catalog
              2. Group changes by pipeline file
              3. Create a single PR addressing all issues
              4. Send a summary Slack notification
          EOF

          rm -f /tmp/kubeopencode-ca.crt
